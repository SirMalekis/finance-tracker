<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢—Ä–µ–∫–µ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- */
        :root { --primary-color: #007bff; --primary-hover: #0056b3; --danger-color: #dc3545; --danger-hover: #c82333; --success-color: #28a745; --background-color: #f8f9fa; --card-background: #ffffff; --text-color: #343a40; --border-color: #dee2e6; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 2em; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; background: var(--card-background); padding: 2em; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        h1, h2, h3, h4 { color: var(--text-color); font-weight: 600; }
        .hidden { display: none; }
        .user-info { font-weight: 600; color: var(--primary-color); }
        .income { color: var(--success-color); }
        .expense { color: var(--danger-color); }
        .link-button { background: none; border: none; color: var(--primary-color); text-decoration: underline; cursor: pointer; padding: 0; font-size: 1em; font-weight: 600; }
        .link-button:hover { color: var(--primary-hover); }

        /* --- –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è --- */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .notification {
            padding: 1em 1.5em;
            border-radius: 8px;
            color: #FFFFFF !important;
            font-size: 1em !important;
            font-weight: 600 !important;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .notification.show { opacity: 1; transform: translateX(0); }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }

        /* --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ --- */
        form { margin-bottom: 1.5em; padding: 1.5em; border: 1px solid var(--border-color); border-radius: 8px; background-color: #fdfdfd; }
        .form-group { margin-bottom: 1em; position: relative; }
        .form-group label { display: block; margin-bottom: 0.5em; font-weight: 600; }
        input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="password"], select { width: 100%; padding: 0.7em; border-radius: 5px; border: 1px solid var(--border-color); box-sizing: border-box; }
        input[type="password"] { padding-right: 40px; }
        .password-toggle { position: absolute; right: 10px; top: 70%; transform: translateY(-50%); cursor: pointer; font-size: 1.2em; user-select: none; }
        button { cursor: pointer; background-color: var(--primary-color); color: white; border: none; padding: 0.8em 1.5em; border-radius: 5px; font-weight: 600; transition: background-color 0.2s; }
        button:hover { background-color: var(--primary-hover); }
        button.delete-btn { background-color: var(--danger-color); }
        button.delete-btn:hover { background-color: var(--danger-hover); }
        .tab-buttons button { margin-right: 10px; margin-bottom: 10px; }
        .tab-buttons button.active { background-color: var(--text-color); }

        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { border: 1px solid var(--border-color); padding: 0.8em; text-align: left; }
        th { background-color: #f2f2f2; font-weight: 600; }
        tbody tr:nth-child(even) { background-color: var(--background-color); }
        tbody tr:hover { background-color: #e9ecef; }

        .admin-section { margin-top: 2em; border-top: 2px solid var(--border-color); padding-top: 1.5em; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: var(--card-background); margin: 10% auto; padding: 2em; border: 1px solid var(--border-color); border-radius: 8px; width: 80%; max-width: 500px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; }

    </style>
</head>
<body>
    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="message-box"></div>

    <div class="container">
        <!-- –ë–ª–æ–∫ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="auth-section">
            <div id="login-container">
                <h2>–í—Ö–æ–¥</h2>
                <form id="login-form"> <div class="form-group"><label for="login-email">Email</label><input type="email" id="login-email" required></div> <div class="form-group"><label for="login-password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="login-password" required><span class="password-toggle" onclick="togglePassword('login-password', this)">üëÅÔ∏è</span></div> <button type="submit">–í–æ–π—Ç–∏</button> </form>
                <p>–ï—â–µ –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <button class="link-button" onclick="showAuthForm('register')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</button></p>
            </div>
            <div id="register-container" class="hidden">
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <form id="register-form"> <div class="form-group"><label for="register-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label><input type="text" id="register-username" required></div> <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div> <div class="form-group"><label for="register-password">–ü–∞—Ä–æ–ª—å</label><input type="password" id="register-password" required><span class="password-toggle" onclick="togglePassword('register-password', this)">üëÅÔ∏è</span></div> <div class="form-group"><label for="register-password-confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label><input type="password" id="register-password-confirm" required><span class="password-toggle" onclick="togglePassword('register-password-confirm', this)">üëÅÔ∏è</span></div> <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button> </form>
                <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <button class="link-button" onclick="showAuthForm('login')">–í–æ–π–¥–∏—Ç–µ</button></p>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
        <div id="app-section" class="hidden">
            <h1>üí∞ –¢—Ä–µ–∫–µ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
            <p class="user-info">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <span id="user-info"></span> | <button id="logout-btn">–í—ã–π—Ç–∏</button></p>

            <h3>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h3>
            <form id="add-transaction-form">
                <div class="form-group"><label for="transaction-type">–¢–∏–ø</label><select id="transaction-type" required><option value="expense">–†–∞—Å—Ö–æ–¥</option><option value="income">–î–æ—Ö–æ–¥</option></select></div>
                <div class="form-group"><label for="amount">–°—É–º–º–∞</label><input type="number" step="0.01" id="amount" required></div>
                 <div class="form-group"><label for="currency">–í–∞–ª—é—Ç–∞</label><select id="currency" required><option value="RUB">RUB</option><option value="KZT">KZT</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select></div>
                <div class="form-group"><label for="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><input type="text" id="category" placeholder="–Ω–∞–ø—Ä., –ï–¥–∞, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç" required></div>
                <div class="form-group"><label for="date">–î–∞—Ç–∞</label><input type="date" id="date" required></div>
                <div class="form-group"><label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="text" id="description"></div>
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>

            <h3>–ú–æ–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
            <table id="transactions-table">
                <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–°—É–º–º–∞</th><th>–í–∞–ª—é—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="admin-section" class="hidden admin-section">
            <h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h3>
            <div class="tab-buttons"><button id="show-all-transactions-btn" class="active">–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</button><button id="show-all-users-btn">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</button></div>
            <div id="all-transactions-tab" class="tab-content"><h4>–í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4><table id="admin-transactions-table"><thead><tr><th>–ê–≤—Ç–æ—Ä</th><th>–î–∞—Ç–∞</th><th>–¢–∏–ø</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–°—É–º–º–∞</th><th>–í–∞–ª—é—Ç–∞</th></tr></thead><tbody></tbody></table></div>
            <div id="all-users-tab" class="tab-content hidden"><h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4><table id="admin-users-table"><thead><tr><th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- –û–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h3>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-expense-id">
                <div class="form-group"><label for="edit-transaction-type">–¢–∏–ø</label><select id="edit-transaction-type" required><option value="expense">–†–∞—Å—Ö–æ–¥</option><option value="income">–î–æ—Ö–æ–¥</option></select></div>
                <div class="form-group"><label for="edit-amount">–°—É–º–º–∞</label><input type="number" step="0.01" id="edit-amount" required></div>
                <div class="form-group"><label for="edit-currency">–í–∞–ª—é—Ç–∞</label><select id="edit-currency" required><option value="RUB">RUB</option><option value="KZT">KZT</option><option value="USD">USD</option><option value="EUR">EUR</option><option value="GBP">GBP</option></select></div>
                <div class="form-group"><label for="edit-category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><input type="text" id="edit-category" required></div>
                <div class="form-group"><label for="edit-date">–î–∞—Ç–∞</label><input type="date" id="edit-date" required></div>
                <div class="form-group"><label for="edit-description">–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="edit-description"></div>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let currentToken = localStorage.getItem('token');
        let currentUser = null;

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å UI ---
        function showSection(sectionId) { document.querySelectorAll('#auth-section, #app-section, #admin-section').forEach(s => s.classList.add('hidden')); document.getElementById(sectionId).classList.remove('hidden'); }
        function showAuthForm(formType) { document.getElementById('login-container').classList.add('hidden'); document.getElementById('register-container').classList.add('hidden'); if (formType === 'login') { document.getElementById('login-container').classList.remove('hidden'); } else { document.getElementById('register-container').classList.remove('hidden'); } }
        function togglePassword(inputId, icon) { const input = document.getElementById(inputId); if (input.type === 'password') { input.type = 'text'; icon.textContent = 'üôà'; } else { input.type = 'password'; icon.textContent = 'üëÅÔ∏è'; } }
        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–°–ü–õ–´–í–ê–Æ–©–ò–• –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---
        function showMessage(text, type = 'success') {
            const box = document.getElementById('message-box');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = text;
            box.appendChild(notification);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => notification.classList.add('show'), 10);

            // –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.classList.remove('show');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º ---
        const modal = document.getElementById('edit-modal');
        const span = document.getElementsByClassName("close")[0];
        span.onclick = function() { modal.style.display = "none"; }
        window.onclick = function(event) { if (event.target == modal) { modal.style.display = "none"; } }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (currentToken) options.headers['Authorization'] = `Bearer ${currentToken}`;
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(API_URL + endpoint, options);
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            return data;
        }

        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }

        function renderTransactions(transactions, tableBodyId) {
            const tbody = document.querySelector(`#${tableBodyId} tbody`);
            tbody.innerHTML = '';
            transactions.forEach(t => {
                const row = tbody.insertRow();
                const typeClass = t.transaction_type === 'income' ? 'income' : 'expense';
                const amountText = t.transaction_type === 'income' ? `+${t.amount}` : `-${t.amount}`;

                if (tableBodyId === 'transactions-table') {
                    row.innerHTML = `
                        <td>${formatDate(t.date)}</td>
                        <td class="${typeClass}">${t.transaction_type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}</td>
                        <td>${escapeHtml(t.category)}</td>
                        <td class="${typeClass}">${amountText}</td>
                        <td>${t.currency}</td>
                        <td>${escapeHtml(t.description)}</td>
                        <td>
                            <button class="delete-btn" onclick="deleteTransaction(${t.id})">–£–¥–∞–ª–∏—Ç—å</button>
                            <button onclick="openEditModal(${t.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </td>`;
                } else { row.innerHTML = `<td>${escapeHtml(t.author)}</td><td>${formatDate(t.date)}</td><td class="${typeClass}">${t.transaction_type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}</td><td>${escapeHtml(t.category)}</td><td class="${typeClass}">${amountText}</td><td>${t.currency}</td>`; }
            });
        }

        function renderUsers(users) {
            const tbody = document.querySelector('#admin-users-table tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${u.id}</td><td>${escapeHtml(u.username)}</td><td>${escapeHtml(u.email)}</td><td>${u.role}</td><td><button class="delete-btn" onclick="deleteUser(${u.id}, '${escapeHtml(u.username)}')">–£–¥–∞–ª–∏—Ç—å</button></td>`;
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        async function deleteTransaction(id) { if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?')) return; try { await apiCall(`/expenses/${id}`, 'DELETE'); showMessage('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞!'); loadApp(); } catch (error) { showMessage(error.message, 'error'); } }
        async function deleteUser(id, username) { if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}" –∏ –≤—Å–µ –µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏?`)) return; try { await apiCall(`/admin/users/${id}`, 'DELETE'); showMessage(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" —É–¥–∞–ª–µ–Ω!`); loadAdminUsers(); } catch (error) { showMessage(error.message, 'error'); } }

        // --- –õ–æ–≥–∏–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ---
        async function openEditModal(id) {
            try {
                const transactions = await apiCall('/expenses');
                const transaction = transactions.find(t => t.id === id);
                if (!transaction) { showMessage('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error'); return; }
                document.getElementById('edit-expense-id').value = transaction.id;
                document.getElementById('edit-transaction-type').value = transaction.transaction_type;
                document.getElementById('edit-amount').value = transaction.amount;
                document.getElementById('edit-currency').value = transaction.currency;
                document.getElementById('edit-category').value = transaction.category;
                document.getElementById('edit-date').value = transaction.date;
                document.getElementById('edit-description').value = transaction.description;
                modal.style.display = "block";
            } catch (error) { showMessage(error.message, 'error'); }
        }

        document.getElementById('edit-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-expense-id').value;
            try {
                await apiCall(`/expenses/${id}`, 'PUT', {
                    transaction_type: document.getElementById('edit-transaction-type').value,
                    amount: parseFloat(document.getElementById('edit-amount').value),
                    currency: document.getElementById('edit-currency').value,
                    category: document.getElementById('edit-category').value,
                    date: document.getElementById('edit-date').value,
                    description: document.getElementById('edit-description').value,
                });
                showMessage('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                modal.style.display = "none";
                loadApp();
            } catch (error) { showMessage(error.message, 'error'); }
        });

        async function loadApp() {
            try {
                const transactions = await apiCall('/expenses');
                const tokenPayload = parseJwt(currentToken);
                currentUser = tokenPayload;
                document.getElementById('user-info').textContent = currentUser.username;
                renderTransactions(transactions, 'transactions-table');
                showSection('app-section');
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadAdminTransactions();
                    loadAdminUsers();
                }
            } catch (error) { console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error); logout(); }
        }

        async function loadAdminTransactions() {
            const allTransactions = await apiCall('/admin/expenses');
            renderTransactions(allTransactions, 'admin-transactions-table');
        }

        async function loadAdminUsers() {
            const allUsers = await apiCall('/admin/users');
            renderUsers(allUsers);
        }

        function logout() {
            localStorage.removeItem('token');
            currentToken = null;
            currentUser = null;
            showSection('auth-section');
            showAuthForm('login');
            showMessage('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.');
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;
            if (password !== passwordConfirm) { showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!', 'error'); return; }
            try {
                await apiCall('/register', 'POST', {
                    username: document.getElementById('register-username').value,
                    email: document.getElementById('register-email').value,
                    password: password,
                    password_confirm: passwordConfirm,
                });
                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
                e.target.reset();
                showAuthForm('login');
            } catch (error) { showMessage(error.message, 'error'); }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const data = await apiCall('/login', 'POST', {
                    email: document.getElementById('login-email').value,
                    password: document.getElementById('login-password').value,
                });
                currentToken = data.token;
                localStorage.setItem('token', currentToken);
                showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                loadApp();
            } catch (error) { showMessage(error.message, 'error'); }
        });

        document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await apiCall('/expenses', 'POST', {
                    transaction_type: document.getElementById('transaction-type').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    currency: document.getElementById('currency').value,
                    category: document.getElementById('category').value,
                    date: document.getElementById('date').value,
                    description: document.getElementById('description').value,
                });
                showMessage('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                e.target.reset();
                loadApp();
            } catch (error) { showMessage(error.message, 'error'); }
        });

        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('show-all-transactions-btn').addEventListener('click', function() { document.getElementById('all-transactions-tab').classList.remove('hidden'); document.getElementById('all-users-tab').classList.add('hidden'); this.classList.add('active'); document.getElementById('show-all-users-btn').classList.remove('active'); });
        document.getElementById('show-all-users-btn').addEventListener('click', function() { document.getElementById('all-transactions-tab').classList.add('hidden'); document.getElementById('all-users-tab').classList.remove('hidden'); this.classList.add('active'); document.getElementById('show-all-transactions-btn').classList.remove('active'); });

        // --- –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        if (currentToken) { loadApp(); } else { showSection('auth-section'); showAuthForm('login'); }
    </script>
</body>
</html>